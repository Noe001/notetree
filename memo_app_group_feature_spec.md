# Notetree グループ機能 詳細仕様書

## 機能概要

- 目的: メモアプリにグループ機能を追加し、メモを複数ユーザーで共有・コラボレーションできるようにする。
- 対象: Next.js製の既存メモアプリ ([https://github.com/Noe001/notetree](https://github.com/Noe001/notetree)) をベースに拡張。

---

## 1. 要件定義

### 1.1 ユーザー要件

- ユーザーは複数のグループを作成・参加できる。
- グループ内メンバーはグループ配下のメモを閲覧・編集できる。
- グループへの招待は既存ユーザー検索から行う。
- メモは個人メモまたはグループメモとして作成・管理できる。

### 1.2 システム要件

- グループモデルを追加（多対多: ユーザー⇄グループ）。
- メモをグループに紐付け可能に。
- 権限管理: オーナー、管理者、メンバー。
- リアルタイム機能: メモのリアルタイム更新（WebSocket）。

---

## 2. ユースケース

### 2.1 基本ユースケース

| 番号  | ユースケース       | アクター     | 前提条件     | 成功フロー                                      | 代替フロー                       |
| --- | ------------ | -------- | -------- | ------------------------------------------ | --------------------------- |
| UC1 | グループ作成       | ログインユーザー | ユーザー登録済み | 1. サイドバーの「新しいグループ」ボタンクリック 2. グループ名入力 3. (任意)説明入力 4. 作成ボタン → グループ作成完了 | -                           |
| UC2 | メンバー招待       | グループオーナー | グループ作成済み | 1. グループ選択 2. メンバー管理ダイアログを開く 3. メール/ユーザー選択 4. 招待送信 → メンバー追加完了 | - |
| UC3 | グループ内メモ参照・編集 | グループメンバー | グループ参加済み | 1. サイドバーからグループ選択 2. メモ一覧表示 3. メモ選択→編集 | 権限不足: 閲覧のみ                  |
| UC4 | 個人メモ管理 | ログインユーザー | ログイン済み | 1. サイドバーの「個人メモ」選択 2. 個人メモ一覧表示 3. メモ選択→編集 | - |

### 2.2 詳細ユースケース

#### UC1: グループ作成
- トリガー: サイドバーの「新しいグループ」ボタン
- 入力: グループ名（必須）、説明（任意）
- 処理:
  1. CreateGroupDialogコンポーネントが表示される
  2. ユーザーがグループ情報を入力
  3. グループ作成APIが呼び出される
  4. グループリストが更新される
- 結果: 新しいグループがサイドバーのグループ一覧に追加される

#### UC2: メンバー招待
- トリガー: グループ選択後のメンバー管理機能
- 入力: 招待するユーザーのメールアドレス、ロール（メンバー/管理者）
- 処理:
  1. MemberManagementDialogコンポーネントが表示される
  2. ユーザーが招待情報を入力
  3. 招待APIが呼び出される
  4. メンバーリストが更新される
- 結果: 新しいメンバーがグループに追加される

#### UC3: グループ内メモ参照・編集
- トリガー: サイドバーからグループを選択
- 処理:
  1. グループ選択時にメモリストがフィルタリングされる
  2. グループ内のメモのみが表示される
  3. メモ選択で編集可能
- 結果: グループメモの閲覧・編集が可能

#### UC4: 個人メモ管理
- トリガー: サイドバーの「個人メモ」を選択
- 処理:
  1. 個人メモ選択時にメモリストがフィルタリングされる
  2. 個人メモのみが表示される
  3. メモ選択で編集可能
- 結果: 個人メモの閲覧・編集が可能

---

## 3. ER 図・DB変更

### 3.1 現在のデータ構造

```plaintext
User ←→ GroupMember ←→ Group
Group 1–M Memo
```

### 3.2 テーブル構造

#### groups テーブル
- id (string, UUID)
- name (string)
- description (text, optional)
- isPublic (boolean)
- createdAt (datetime)
- updatedAt (datetime)
- ownerId (string, foreign key to User)

#### group_members テーブル
- id (string, UUID)
- groupId (string, foreign key to Group)
- userId (string, foreign key to User)
- role (enum: 'owner'/'admin'/'member')
- joinedAt (datetime)

#### memos テーブル
- id (string, UUID)
- title (string)
- content (text)
- tags (string array)
- updatedAt (datetime)
- createdAt (datetime)
- isPrivate (boolean)
- userId (string, foreign key to User)
- groupId (string, nullable, foreign key to Group)

---

## 4. APIエンドポイント

### 4.1 グループ管理

| HTTP   | Path         | Params            | 説明                  |
| ------ | ------------ | ----------------- | ------------------- |
| GET    | /groups      | --                | 所有・参加グループ一覧取得       |
| POST   | /groups      | name, description | グループ作成              |
| GET    | /groups/\:id | --                | グループ詳細(メンバー一覧・メモ一覧) |
| PUT    | /groups/\:id | name, description | グループ情報更新            |
| DELETE | /groups/\:id | --                | グループ削除              |

### 4.2 メンバー招待・管理

| HTTP   | Path                                 | Params                  | 説明      |
| ------ | ------------------------------------ | ----------------------- | ------- |
| POST   | /groups/\:group\_id/invitations      | email, role | メンバー招待 |
| DELETE | /groups/\:group\_id/users/\:user\_id | --                      | メンバー削除    |

### 4.3 メモ操作 (グループ対応)

| HTTP   | Path         | Params            | 説明                  |
| ------ | ------------ | ----------------- | ------------------- |
| GET    | /memos      | userId, groupId | メモ一覧取得（フィルタリング対応） |
| POST   | /memos      | title, content, tags, isPrivate, groupId | メモ作成 |
| GET    | /memos/\:id | --                | メモ詳細取得 |
| PATCH  | /memos/\:id | title, content, tags, isPrivate, groupId | メモ更新 |
| DELETE | /memos/\:id | --                | メモ削除 |

---

## 5. 権限管理

### 5.1 ロール定義

- **オーナー (owner)**: グループ作成者。グループ削除・メンバー管理可。
- **管理者 (admin)**: メンバー招待/削除、メモ編集可。
- **メンバー (member)**: メモ閲覧・編集可。

### 5.2 権限マトリクス

| 操作 | オーナー | 管理者 | メンバー | 非メンバー |
| --- | --- | --- | --- | --- |
| グループ削除 | ○ | × | × | × |
| メンバー招待 | ○ | ○ | × | × |
| メンバー削除 | ○ | ○ | × | × |
| メモ作成 | ○ | ○ | ○ | × |
| メモ編集 | ○ | ○ | ○ | × |
| メモ閲覧 | ○ | ○ | ○ | × |

---

## 6. UI 仕様

### 6.1 全体構造

```
メインアプリケーション (Appコンポーネント)
├── メモ一覧パネル (MemoListPanel)
├── メモエディタ (MemoEditor)
└── サイドバー (SidebarContent in Sheet)
    ├── ユーザープロファイル
    ├── グループセクション
    │   ├── 個人メモ (デフォルト選択)
    │   ├── グループ一覧 (動的表示)
    │   └── 新しいグループボタン
    ├── ナビゲーション
    └── ログアウト
```

### 6.2 コンポーネント詳細

#### 6.2.1 メインアプリケーション (Appコンポーネント)

**責務**: アプリケーション全体の状態管理とコンポーネントの統合

**状態管理**:
- `memos`: メモ一覧
- `selectedMemo`: 選択中のメモ
- `searchQuery`: 検索クエリ
- `sortKey`: ソートキー
- `activeTags`: アクティブなタグ
- `selectedGroupId`: 選択中のグループID
- `groups`: グループ一覧

**主要機能**:
- メモのCRUD操作
- グループ選択によるメモフィルタリング
- 検索・ソート・タグフィルタリング

#### 6.2.2 メモ一覧パネル (MemoListPanel)

**責務**: メモ一覧の表示と操作

**プロパティ**:
- `memos`: 表示するメモ一覧
- `selectedMemo`: 選択中のメモ
- `onSelectMemo`: メモ選択時のコールバック
- `onSearch`: 検索クエリ変更時のコールバック
- `onSort`: ソートキー変更時のコールバック
- `onTagToggle`: タグ選択時のコールバック
- `activeTags`: アクティブなタグ
- `onCreateMemo`: メモ作成時のコールバック
- `allTags`: すべてのタグ
- `selectedGroupId`: 選択中のグループID
- `groups`: グループ一覧

**表示要素**:
- ヘッダー（個人メモまたはグループ名を動的に表示）
- 検索ボックス
- ソートセレクトボックス
- タグフィルター
- メモ一覧（MemoItemコンポーネント）

#### 6.2.3 メモアイテム (MemoItem)

**責務**: 個別のメモの表示

**プロパティ**:
- `memo`: メモデータ
- `isSelected`: 選択状態
- `onSelect`: 選択時のコールバック

**表示要素**:
- タイトル
- 更新日時
- コンテンツのプレビュー
- タグバッジ
- プライベートアイコン

#### 6.2.4 メモエディタ (MemoEditor)

**責務**: メモの編集

**プロパティ**:
- `memo`: 編集中のメモ
- `onUpdateMemo`: メモ更新時のコールバック

**機能**:
- タイトル編集（リアルタイム保存）
- タグ編集（カンマ区切り）
- コンテンツ編集（リアルタイム保存）
- プライバシー切り替え

#### 6.2.5 サイドバー (SidebarContent)

**責務**: グループ選択とナビゲーション

**プロパティ**:
- `onOpenSettings`: 設定ダイアログ表示
- `onOpenProfile`: プロファイルダイアログ表示
- `onOpenMemberManagement`: メンバー管理ダイアログ表示
- `onOpenSearchResults`: 検索結果ダイアログ表示
- `onOpenExportImport`: エクスポート/インポートダイアログ表示
- `onOpenKeyboardShortcuts`: キーボードショートカットダイアログ表示
- `onOpenCreateGroup`: グループ作成ダイアログ表示
- `groups`: グループ一覧
- `selectedGroupId`: 選択中のグループID
- `onGroupSelect`: グループ選択時のコールバック

**表示要素**:
- ユーザープロファイル
- グループセクション
  - 個人メモボタン（デフォルト選択）
  - グループ一覧（動的表示）
  - 新しいグループボタン
- ナビゲーションメニュー
- ログアウトボタン

### 6.3 ダイアログコンポーネント

#### 6.3.1 グループ作成ダイアログ (CreateGroupDialog)

**機能**:
- グループ名入力
- 説明入力（任意）
- グループ作成処理

#### 6.3.2 メンバー管理ダイアログ (MemberManagementDialog)

**機能**:
- グループメンバー一覧表示
- メンバー招待（メールアドレス入力）
- ロール選択（メンバー/管理者）
- メンバー削除

#### 6.3.3 メモ編集ダイアログ (MemoEditDialog)

**機能**:
- メモの詳細編集
- タイトル、コンテンツ、タグの編集

#### 6.3.4 メモ削除ダイアログ (MemoDeleteDialog)

**機能**:
- メモ削除確認
- 削除処理

---

## 7. フィルタリングとソート

### 7.1 メモフィルタリングロジック

**グループフィルタリング**:
```javascript
const matchesGroup = selectedGroupId 
  ? memo.groupId === selectedGroupId 
  : !memo.groupId || memo.groupId === null;
```

- グループ選択時: 選択されたグループIDと一致するメモのみ表示
- 個人メモ選択時: groupIdがnullまたは存在しないメモのみ表示

**検索フィルタリング**:
- タイトルとコンテンツに対して部分一致検索

**タグフィルタリング**:
- 選択されたすべてのタグを含むメモのみ表示

### 7.2 ソートロジック

- 更新日時（降順）: デフォルト
- 作成日時（降順）
- タイトル（昇順、日本語対応）

---

## 8. リアルタイム機能

### 8.1 WebSocket接続

- メモのリアルタイム更新に対応
- グループメンバーのオンライン状態表示（予定）

### 8.2 更新通知

- メモ作成/更新/削除時のリアルタイム反映
- メンバー参加/離脱通知（予定）

---

## 9. セキュリティ

### 9.1 認証

- メール/パスワード認証
- ローカルストレージによるセッション管理

### 9.2 認可

- APIレベルでのグループアクセス制御
- フロントエンドでの権限チェック

### 9.3 データ保護

- プライベートメモのグループ内非表示
- グループメモの適切なアクセス制御

---

## 10. パフォーマンス

### 10.1 メモ操作

- デバウンスによる自動保存（2秒）
- メモ選択時の即時反映

### 10.2 データ取得

- 初回ロード時の全メモ取得
- グループ選択時のフィルタリング（クライアントサイド）

### 10.3 レンダリング最適化

- メモ一覧の仮想スクロール（予定）
- コンポーネントのメモ化

---

## 11. テスト

### 11.1 単体テスト

- 各コンポーネントのプロパティテスト
- フィルタリングロジックのテスト
- APIクライアントのテスト

### 11.2 統合テスト

- グループ作成フロー
- メンバー招待フロー
- メモ作成・編集フロー
- グループ間のメモ切り替え

### 11.3 E2Eテスト

- Playwrightによるブラウザテスト
- グループ機能のシナリオテスト

---

## 12. 今後の拡張機能（フェーズ2以降）

### 12.1 フォルダ機能
- グループ内でのフォルダ階層管理
- メモのフォルダ内配置

### 12.2 添付ファイル
- メモへの画像/ファイル添付
- グループ内でのファイル共有

### 12.3 通知機能
- メモ更新通知
- メンバー招待通知
- リアルタイムコメント

### 12.4 検索強化
- 全文検索
- フィルター保存
- 検索履歴

---

以上が、Notetreeアプリケーションのグループ機能に関する詳細な仕様書です。実装状況や要件変更に応じて随時更新してください。
