**機能概要**

- 目的: メモアプリにグループ機能を追加し、メモやファイル・フォルダを複数ユーザーで共有・コラボレーションできるようにする。
- 対象: Rails製の既存メモアプリ ([https://github.com/Noe001/notetree](https://github.com/Noe001/notetree)) をベースに拡張。

---

## 1. 要件定義

### 1.1 ユーザー要件

- ユーザーは複数のグループを作成・参加できる。
- グループ内メンバーはグループ配下のメモ・フォルダ・ファイルを閲覧・編集できる。
- グループへの招待はメールまたは既存ユーザー検索から行う。
- 招待されたユーザーは招待メールのリンクから参加を承認可能。

### 1.2 システム要件

- グループモデルを追加（多対多: ユーザー⇄グループ）。
- メモ・フォルダ・添付ファイルをグループに紐付け可能に。
- 権限管理: オーナー、管理者、メンバー。
- 招待トークン・認可ロジック。
- 通知機能: 招待・承認・メンバー追加・変更。

---

## 2. ユースケース

| 番号  | ユースケース       | アクター     | 前提条件     | 成功フロー                                      | 代替フロー                       |
| --- | ------------ | -------- | -------- | ------------------------------------------ | --------------------------- |
| UC1 | グループ作成       | ログインユーザー | ユーザー登録済み | 1. グループ名入力 2. (任意)説明入力 3. 作成ボタン → グループ作成完了 | -                           |
| UC2 | メンバー招待       | グループオーナー | グループ作成済み | 1. メール/ユーザー選択 2. 招待送信 → 招待メール発行/DBにトークン保存  | 招待対象が未登録ユーザー: サインアップ案内メール送信 |
| UC3 | 招待承認         | 招待ユーザー   | 招待メール受領  | 1. メール内リンククリック 2. 承認ボタン → グループ参加完了         | リンク期限切れ: 再招待依頼メッセージ表示       |
| UC4 | グループ内メモ参照・編集 | グループメンバー | グループ参加済み | 1. グループページ遷移 2. メモ一覧表示 3. メモ選択→編集/コメント追加   | 権限不足: 閲覧のみ                  |

---

## 3. ER 図・DB変更

```plaintext
User ←→ UserGroup ←→ Group
Group 1–M Memo
Group 1–M Folder   (Phase 2)
Folder 1–M Memo    (Phase 2)
Memo 1–M Attachment (ActiveStorage, Phase 2)
```

### 新規テーブル・カラム

- **groups**
  - id, name\:string, description\:text, owner\_id\:integer
  - timestamps
- **user\_groups**
  - id, user\_id\:integer, group\_id\:integer, role\:string(enum: owner/admin/member)
  - timestamps
- **invitations**
  - id, group\_id\:integer, token\:string, invited\_user\_id\:integer (nullable), email\:string, role\:string, expires\_at\:datetime, accepted\_at\:datetime
  - timestamps
- **memos** テーブルに追加カラム
  - group\_id\:integer (nullable)
- **folders** テーブルに追加カラム (Phase 2)
  - group\_id\:integer (nullable)

---

## 4. APIエンドポイント

### グループ管理

| HTTP   | Path         | Params            | 説明                  |
| ------ | ------------ | ----------------- | ------------------- |
| GET    | /groups      | --                | 所有・参加グループ一覧取得       |
| POST   | /groups      | name, description | グループ作成              |
| GET    | /groups/\:id | --                | グループ詳細(メンバー一覧・メモ一覧) |
| PUT    | /groups/\:id | name, description | グループ情報更新            |
| DELETE | /groups/\:id | --                | グループ削除              |

### メンバー招待・管理

| HTTP   | Path                                 | Params                  | 説明      |
| ------ | ------------------------------------ | ----------------------- | ------- |
| POST   | /groups/\:group\_id/invitations      | email or user\_id, role | 招待メール送信 |
| GET    | /invitations/accept?token=...        | token                   | 招待承認    |
| DELETE | /groups/\:group\_id/users/\:user\_id | --                      | 参加解除    |

### メモ／フォルダ操作 (グループ)

- 既存エンドポイントに `group_id` パラメータを追加してフィルタリング

---

## 5. 権限管理

- **オーナー**: グループ作成者。グループ削除・メンバー管理可。
- **管理者**: メンバー招待/削除、メモ編集可。
- **メンバー**: メモ閲覧・編集・コメント可。

認可ライブラリ: Pundit or Cancancan 推奨。

---

## 6. UI 仕様

1. **グループ一覧画面**
   - 右サイドバーに "My Groups" セクション
   - グループカード: 名前 + 説明 + 未読メモ数
2. **グループ詳細画面**
   - タブ: メモ/フォルダ/メンバー
   - メンバータブ: 招待ボタン + 参加者リスト (ロール表示)
   - 招待モーダル: メール or ユーザー検索 + ロール選択
3. **メモ作成/編集画面**
   - `Group` ドロップダウンで所属グループ選択
   - 共有設定表示 (リンクでシェア or メンバーのみ)

---

## 7. 通知・メール

- **招待メール**: トークン付きURL
- **承認完了メール**: グループ参加完了通知
- **新規メモ作成通知 (オプション)**: グループメンバーにメール/アプリ内通知

---

## 8. マイルストーン & 見積

| フェーズ   | 作業内容             | 工数 (日) |
| ------ | ---------------- | ------ |
| 設計     | DB設計・API仕様書作成    | 1      |
| 実装     | モデル・コントローラ・ビュー追加 | 3      |
| 認証・認可  | 招待ロジック・Pundit設定  | 2      |
| テスト    | RSpec/Capybara   | 2      |
| ドキュメント | リリースノート・操作マニュアル  | 1      |

合計: 約9日

---

以上が、「notetree」にグループ機能を追加するための具体的な仕様書案です。 要望に応じてさらに詳細化できますので、気軽にフィードバックください！

